---
title: "Descriptive Analysis of US meteorological activity using NOAA Storm Database"
output: 
  html_document:
    keep_md: false
---

## Introduction

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

## Data

The data for this assignment come from the NOAA Storm Database, and is in the form of a comma-separated-value file compressed via the bzip2 algorithm to reduce its size ([Download dataset here][https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2]). Codebook and data dictionary can be found [here][https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf]. The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

## Questions

We will address the following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

## Analysis

### Processing data

As mentioned above, data is taken from the NOAA Storm Database. The relevant data for our analysis are the following:

1. `BGN_DATE`: date of occurrence or first observation of the phenomenon. Date.
2. `BGN_TIME`: time of occurrence or first observation. Time.
3. `TIME_ZONE`: timezone of the location of first observation or occurrence. Categorical.
5. `STATE`: state of occurrence. Categorical.
6. `EVTYPE`: Type of event. Categorical.
7. `F`: tornado category in the fujita scale. Numeric.
8. `MAG`: Miles-per-hour of thunderstorm or hailstorm. Numeric.
10. `FATALITIES`: Number of human lives lost to the phenomenon. Numeric.
11. `INJURIES`: Number of people that were injured in the presence of the phenomenon. Numeric.
12. `PROPDMG`: Amount of USD in damage to property in the presence of the phenomenon. Numeric.
13. `PROPDMGEXP`: Scale of the PROPDMG field. NA=1, K=1,000, M=1,000,000, B=1,000,000,000. Numeric (will be fused with PROPDMG field during processing).
14. `CROPDMG`: Amount of USD in damage to agricultural crops. Numeric.
15. `CROPDMGEXP`: Scale of the CROPDMG field. NA=1, K=1,000, M=1,000,000, B=1,000,000,000. Numeric (will be fused with CROPDMG field during processing).

```{r preparedata,echo=TRUE,message=FALSE,warning=FALSE}
options(scipen = 999, digits = 2) # Set scientific notation digits

# Load required libraries
if (!require(lubridate)) {stop('Package lubridate must be installed before proceeding.')}
if (!require(dplyr)) {stop('Package dplyr must be installed before proceeding.')}
if (!require(ggplot2)) {stop('Package ggplot2 must be installed before proceeding.')}
if (!require(stringr)) {stop('Package stringr must be installed before proceeding.')}
if (!require(tidyr)) {stop('Package tidyr must be installed before proceeding.')}
if (!require(xtable)) {stop('Package xtable must be installed before proceeding.')}

# Download and process data
downloadedFilename <- 'StormData.csv.bz2'
if (!file.exists(downloadedFilename)) {
    dataUrl <- paste('https://d396qusza40orc.cloudfront.net/repdata/data/',downloadedFilename, sep = '')
    download.file(dataUrl, destfile = downloadedFilename, method='curl')
}

# Read-in file, converting empty strings and NA to NA
if (!exists('crude')) {
  crude <- read.csv(downloadedFilename, stringsAsFactors = F, strip.white=T, na.strings=c('NA',''))
}

# Build character vector by concatenating BGN_DATE and BGN_TIME.
stormCharTime <- paste(unlist(strsplit(crude$BGN_DATE, split = ' '))[rep(c(T,F), (nrow(crude)/2))],
                       crude$BGN_TIME, crude$TIME_ZONE)

# Create new dataframe with only the columns we're interested in. We're also merging crop and property damage amount with their respective scales.
if (!exists('storms')) {
  storms <- data.frame(
    timestamp=as.factor(stormCharTime),
    state=as.factor(crude$STATE),
    eventtype=as.factor(crude$EVTYPE),
    fujita=as.factor(crude$F),
    magnitude=as.numeric(crude$MAG),
    fatalities=as.numeric(crude$FATALITIES),
    injuries=as.numeric(crude$INJURIES),
    propertydamage=as.numeric(crude$PROPDMG)*as.numeric(ifelse(crude$PROPDMGEXP %in% c('k','K'), 1000,
                                         ifelse(crude$PROPDMGEXP %in% c('M','m'), 1000000,
                                         ifelse(crude$PROPDMGEXP %in% c('B','b'), 1000000000,
                                         ifelse(crude$PROPDMGEXP %in% c('h','H'), 100,1))))),
    cropdamage=as.numeric(crude$CROPDMG)*as.numeric(ifelse(crude$CROPDMGEXP %in% c('k','K'), 1000,
                                         ifelse(crude$CROPDMGEXP %in% c('M','m'), 1000000,
                                         ifelse(crude$CROPDMGEXP %in% c('B','b'), 1000000000,
                                         ifelse(crude$CROPDMGEXP %in% c('h','H'), 100,1)))))
  )
}
```

Having done the processing and narrowing down columns of interest, we can now proceed to answer the questions that concern this study.

## Which types of events are most harmful with respect to population health? 

### Definition of 'population health'
For the purpose of this study, we define 'population health' as any injury to human lives caused by the weather phenomenon that results in temporary or permanent physical damage, or a fatality.

### Injuries and fatalities by type of weather event

We'll tackle this question first by plotting the total count of both injured and fatal losses per event type. Also, we will focus on the 20 most harmful events and not on the entire set due to several of the event categories claiming no human lives nor injured population.

```{r humancostplot, message=FALSE, fig.height=6, fig.width=11}

# Group by eventtype, summarize by injuries + fatalities and arrange by injuries + fatalities
harmfulevents <- storms %>% group_by(eventtype) %>% 
  summarise(dead=sum(fatalities),  
            wounded=sum(injuries), 
            dandw=sum(dead+wounded),
            deadpct=(dead/dandw),
            woundedpct=(wounded/dandw), 
            dandwpct=(dandw/dandw)) %>% 
  arrange(desc(dandw))

# Top 20 harmful events
top20 <- slice(harmfulevents, 1:20)

# make data long and narrow for ggplot2
gathered <- gather(top20, type, count, -c(eventtype, dandw, dandwpct, deadpct, woundedpct))

# rearrange event types to sort them in the plot 
gathered <- mutate(gathered, eventtype=factor(eventtype, levels = top20$eventtype))

ggplot(gathered, aes(x=eventtype, y=count, fill=type)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x='Type of weather event', y='Fatalities + Injured count', title='Top 20 weather phenomena most damaging\nto human lives in the US (1950-2011)')

# Total human cost for tornadoes
totalhumancosttornadoes <- (filter(top20, eventtype=='TORNADO') %>% select(dandw))
totalhumancost <- sum(harmfulevents$dandw)

```

We can see that tornadoes are by far the weather phenomenon that inflicts the most damage on human lives, with *`r totalhumancosttornadoes`* people either injuried or killed, a whopping *`r (totalhumancosttornadoes/totalhumancost)*100`%* of the entire data set.

The effect of so high a number eclipses the contribution to human cost of the rest of the phenomena, so we'll show a 2nd plot WITHOUT data for tornadoes.

```{r notornadoplot, message=FALSE, fig.height=6, fig.width=11}

# remove rows for tornadoes
notornado <- filter(gathered, eventtype!='TORNADO')

ggplot(notornado, aes(x=eventtype, y=count, fill=type)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x='Type of weather event', y='Fatalities + Injured count', title='Lower 19 of the top 20 weather phenomena most damaging\nto human lives in the US (1950-2011)')

```

The plot shows that the weather phenomena that inflict the most human suffering, *after tornadoes* are:

2. Intense heat waves
3. Thunderstorm winds
4. Floods
5. Lightning
6. Heat waves
7. Flash floods

Finally, to summarize these findings, we show a table for these top 20 phenomena, ordered by fatalities, with their total cost, and percent of fatalities and injuries as fractions of total costs.

```{r table, message=FALSE,results='asis'}
tab <- transmute(top20, WeatherPhenomenon=eventtype, TotalHumanCost=dandw, PercentInjured=woundedpct*100, PercentKilled=deadpct*100) %>% arrange(desc(PercentKilled)) %>% slice(1:20)

print(xtable(tab), type='html', include.rownames=FALSE)

```